# BLE File Transfer Service

The need in this proprietary service arises from the absence of a convenient file transfer protocol 
that could be used to transfer files from Dictofun to host (PC, iPhone or Android phone). 

There is a standard protocol BLE OTS, which is unfortunately not yet supported properly by Nordic and
has a limited support and not enough examples on all target platofrms. As of January 2022, this topic has
been used for the conclusion above: https://devzone.nordicsemi.com/f/nordic-q-a/79853/file-transfer-over-ble-ots-or-something-else

## Terms

Following terms are used below:

* device - target device containing the files for the transfer. In terms of OTS it's a server. In particular,
this module is designed for BLE SoC, so under device most of the time a SoC is meant.
* host - PC/phone that performs communication with device. Host performs requests. In terms of OTS it's a client.

Terms `device` and `server` can be used interchangeably. Same for `host` and `client`.

## Requirements

This service should implement a simple unidirectional file transfer protocol between a device and a host.

Service should: 
- support file transfer communication between a single server and a single client;
- should be stateless (relative to connection);
- support immediate connection abortion initiated by both client or server;
- implement file list provision from server to client;
- implement file meta-information provision from server to client upon request from client;
- implement file transfer from server to client upon request from client;
- be cross-platform (so it can run on both NRF52 Cortex-M4 and ESP32-C3 Risc-V)

## Architecture

Initial version of the service shall be implemented on top of BLE GATT. It should be possible to extend it later
with either L2CAP channel or to replace the whole module with BLE OTS.

Given architecture follows the design ideas proposed by Nordic in this example project: https://github.com/NordicPlayground/nrf52-ble-image-transfer-demo

Architecture description shall follow the structure of BLE SIG documents (BLE OTS has been taken as a reference: https://www.bluetooth.com/specifications/specs/object-transfer-service-1-0/)

### Service declaration

Device that provides file transfer service shall provide not more than one instance of the service.

UUID of the service has been generated by https://www.uuidgenerator.net:

```
a045a112-b822-4820-8782-bd8faf68807b
```

### Characteristics

Service advertises following set of characteristics.

| Characteristic ID | Name             | Type        |
|:-----------------:|:----------------:|:-----------:|
| 0001              | Control point    | Write       |
| 0002              | Files' list      | Read/Notify |
| 0003              | File Information | Read/Notify |
| 0004              | File Data        | Read/Notify |
| 0005              | FS Status        | Read/Notify |
| 0006              | General Status   | Read/Notify |

#### Control point

`Control point` characteristic shall support following commands:

| Opcode | Procedure                | Parameters        |Response       |
|:-------|:-------------------------|:------------------|:--------------|
| 01     | Request list of files    | N/A               | Status, UINT8 |
| 02     | Request file info        | File ID (UINT64)  | Status, UINT8 |
| 03     | Request file data        | File ID (UINT64)  | Status, UINT8 |
| 04     | Request FS status        | N/A               | Status, UINT8 |


##### Opcode 0x01 - Request list of files

If operation is successful, device shall immediately provide list of existing files through the `Files' list` characteristic. Status code shall be returned otherwise. Data format for the files' list is defined in the characteristic description.

##### Opcode 0x02 - Request file info

If operation is successful, device shall ASAP provide information about the file in JSON format through the `File info` characteristic.
Command format: byte 0 - opcode, bytes 1..8 contain the file ID in little endian format. 

TODO: specify way to signal error to the host (f.e. if file doesn't exist)

##### Opcode 0x03 - Request file data

If operation is successful, device shall ASAP start sending the contents of the file using `File data` characteristic. It will send the whole file, so it's a host's responsibility to figure out the size of the data to expect 
by using `Request file info` command.

TODO: specify way to signal error to the host (f.e. if file doesn't exist)

#### Data transfer procedure for the read/notify characteristics

Data transaction is performed in the following way:
1. device puts the initial value to the characteristic
2. host receives a notification and reads value from the characteristic.
3. if more data is available, device updates the data in the characteristic, then p.2

### Read/Notify characteristics

#### Files' list

Files list is a list of unique-per-FS 64-bit identifiers, each of which corresponds to a file existing in the file system on the device. 

`NB`: basic idea for the particular use-case is to have ID generated from the file creation date and time: YYYY-MM-DD-HH-MM-SS.

Assuming that file system on device contains N files, data consists of following messages:
1. Amount of files in LSB order (if N = 2, then data is `02 00 00 00 00 00 00 00 `)
2. First file identifier (f.e. `00 20 23 01 20 12 23 56`, corresponding to `12:23:56 on 20.Jan.2023`)

... 

(N+1). Last file identifier

If list size extends the available to char size, data can be sent in several portions.

#### File info

File info is a JSON string containing descriptor of a file. Format is straight forward: first 2 bytes contain the JSON size (little endian), rest is a JSON containing meta information about the target file.
It could also be used in order to signal errors in case of a broken file or anything alike. 

#### File data

File data is the raw content of the file as it is contained in the memory on the device. In order to interptet the file host must first read out the metadata of the device.

#### FS Status

FS Status characteristic shall provide general information about the state of the file system. In particular, it shall provide count of files in the FS,
occupied and free space values. 

##### Transaction format

1. Bytes [0,1]: Amount of bytes in the transaction (in LSB order, f.e. `0x0E 0x00` in the start of the development of the given module)
2. Bytes [2-5]: amount of free space in the FS in bytes (`UINT32`)
3. Bytes [6-9]: amount of occupied space in the FS in bytes (`UINT32`)
3. Bytes [10-13]: count of files in the filesystem (`UINT32`)

#### General status

Since many FS operations can be lengthy and are being processed in the OS context, some responses can't be
sent to the client in the form of immediate response. For this case characteristic `General Status` shall be used.
Following statuses shall be reported:

| Opcode | Status                   | Parameters        | Comments                              |
|:-------|:-------------------------|:------------------|:--------------------------------------|
| 01     | OK                       | N/A               | Can be used as a keep-alive packet    |
| 02     | File not found           | File ID (UINT64)  | N/A                                   |
| 03     | FS corrupt               | N/A               | N/A                                   |
| 04     | Transaction aborted      | Reason (UINT8)    | F.e. if record has been started       |
| 05     | Generic error            | N/A               | In case if yet unknown error occurred |

First byte of the characteristic value contains the opcode.
Data afterwards is defined by the table above.
